---
phase: 01-lightbox-viewer
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - _config/filters.js
  - eleventy.config.js
autonomous: false

must_haves:
  truths:
    - "User clicks any image on the site and it opens in a full-viewport lightbox"
    - "User sees image caption/alt text displayed as an overlay at the bottom of the lightbox"
    - "User can navigate between images on the same page using prev/next arrow buttons"
    - "User can navigate between images using left/right arrow keys"
    - "User can close the lightbox via X button, escape key, or clicking the backdrop"
    - "User can swipe left/right to navigate between images on mobile"
    - "User can pinch-to-zoom on images in the lightbox on mobile"
    - "Lightbox opens and closes with smooth animations"
    - "Lightbox groups images by page so navigation stays within the current page's images"
  artifacts:
    - path: "_config/filters.js"
      provides: "Eleventy transform that wraps content images with lightbox markup"
      contains: "lightgallery"
    - path: "eleventy.config.js"
      provides: "Transform registration (if not in filters.js)"
      contains: "lightbox"
  key_links:
    - from: "_config/filters.js"
      to: "content/posts/*.md"
      via: "Eleventy HTML transform processes all output HTML"
      pattern: "lightgallery"
    - from: "_config/filters.js"
      to: "_includes/assets/js/lightbox-init.js"
      via: "Transform adds .lightgallery class that init script selects"
      pattern: "lightgallery"
---

<objective>
Create an Eleventy transform that automatically wraps content images with lightGallery markup so every image on the site opens in a lightbox when clicked, with captions and per-page gallery grouping.

Purpose: This is the core feature -- making every content image lightbox-enabled without manually editing existing or future content.
Output: All site images automatically wrapped with lightbox links, grouped by page, with captions from alt text.
</objective>

<execution_context>
@/Users/grahamharper/.claude/get-shit-done/workflows/execute-plan.md
@/Users/grahamharper/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-lightbox-viewer/01-RESEARCH.md
@.planning/phases/01-lightbox-viewer/01-01-SUMMARY.md
@eleventy.config.js
@_config/filters.js
@_includes/layouts/base.njk
@content/posts/2013-03-25-nore-valley-park.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Eleventy transform to auto-wrap images with lightbox markup</name>
  <files>
    _config/filters.js
  </files>
  <action>
    Add an Eleventy transform in `_config/filters.js` (alongside the existing htmlmin transform) named "lightbox-wrap". This transform runs on all HTML output files and wraps content images with lightGallery-compatible anchor tags.

    The transform must:

    1. Only process `.html` output files (same guard as htmlmin transform).

    2. Find all `<img>` tags in the HTML output. Use regex or string manipulation (no external dependency like PostHTML -- keep it simple and dependency-free).

    3. For each `<img>` found, determine if it should get lightbox treatment:
       - SKIP if the img (or a parent element) has class `no-lightbox`
       - SKIP if the img is already inside an `<a>` tag that has class `lightgallery` (already wrapped)
       - SKIP if the img is inside a `<header>` tag (site logo/header images)
       - SKIP if the img is inside a `<nav>` tag
       - SKIP if the img src contains "favicon" or "icon" or "logo"
       - SKIP if the img has no src attribute

    4. For images that SHOULD get lightbox:
       - If the `<img>` is already wrapped in an `<a>` tag (like the existing `[![alt](url)](url)` pattern which Eleventy renders as `<a href="url"><picture>...</picture></a>`), ADD the `class="lightgallery"` attribute to the existing `<a>` tag. Also add `data-gallery` and `data-title` attributes to the existing `<a>`.
       - If the `<img>` (or `<picture>`) is NOT wrapped in a link, wrap it in a new `<a>` tag.
       - The `<a>` href should point to the highest-resolution image available:
         - If the img is inside a `<picture>` element with `<source>` tags, extract the largest image URL from the srcset (the last/largest width entry). Prefer the original format (jpeg/png) source over avif/webp for the lightbox href, as it's most compatible.
         - If it's a plain `<img>`, use the img's `src` attribute.
         - If the existing `<a>` already has an href pointing to an image URL (Backblaze B2 pattern), keep that href.

    5. Add these attributes to the `<a>` tag:
       - `class="lightgallery"` (append to existing classes if any)
       - `data-gallery="gallery-{page-slug}"` where page-slug is derived from the output path (e.g., `/blog/nore-valley-park/index.html` becomes `nore-valley-park`). This groups images per page for LBOX-09.
       - `data-title="{alt-text}"` where alt-text comes from the `<img>` alt attribute. This provides captions for LBOX-05. If no alt text, omit data-title.

    6. The transform MUST run BEFORE the htmlmin transform. Eleventy transforms run in the order they're registered. Since lightbox-wrap modifies HTML structure and htmlmin minifies it, register lightbox-wrap first. Move the existing htmlmin transform registration to AFTER the lightbox-wrap registration in `_config/filters.js`, or register lightbox-wrap in `eleventy.config.js` before the filters plugin.

    Implementation approach for the regex:
    - Use a two-pass approach:
      - Pass 1: Find `<a>` tags that wrap `<picture>` or `<img>` tags and already link to image URLs. Add lightgallery attributes to those `<a>` tags.
      - Pass 2: Find `<picture>` or `<img>` tags NOT inside `<a>` tags. Wrap them in new `<a class="lightgallery">` tags.
    - Extract page slug from `this.page.url` (available in transform context via `this.page`).
    - Extract alt text from `<img alt="...">` attribute.

    IMPORTANT: Use ES6+ syntax (const, arrow functions, template literals) in the transform function itself since it runs at build time in Node.js. Only the CLIENT-SIDE JS (lightbox-init.js) needs to be ES5 compatible for UglifyJS.

    IMPORTANT: Be careful with regex on HTML. Keep patterns simple and test edge cases:
    - `<picture>` elements with multiple `<source>` tags
    - `<img>` with single or double quoted attributes
    - `<img>` self-closing tags (`<img ... />` and `<img ...>`)
    - Existing `<a href="..."><picture>...<img ...>...</picture></a>` wrapping
  </action>
  <verify>
    - Run `npm run build` and confirm it completes without errors
    - Check a built post HTML file: `cat _site/blog/nore-valley-park/index.html | grep -o 'lightgallery' | wc -l` should show at least 1 match
    - Check gallery grouping: `grep 'data-gallery' _site/blog/nore-valley-park/index.html` should show `data-gallery="gallery-nore-valley-park"`
    - Check caption: `grep 'data-title' _site/blog/nore-valley-park/index.html` should show `data-title="nore valley park kilkenny"`
    - Check that non-content images are NOT wrapped: `grep 'lightgallery' _site/index.html` should not match header/logo images
    - Verify no images are double-wrapped (search for nested `<a class="lightgallery">` inside another `<a class="lightgallery">`)
  </verify>
  <done>Every content image in built HTML output is wrapped with `<a class="lightgallery" data-gallery="gallery-{slug}" data-title="{alt}">`, non-content images are excluded, build succeeds.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify lightbox works end-to-end</name>
  <what-built>
    Complete lightbox implementation: lightGallery library loaded on every page, all content images auto-wrapped with lightbox markup, per-page gallery grouping, captions from alt text.

    This covers ALL phase 1 requirements:
    - LBOX-01: Click any image to open lightbox
    - LBOX-02: Close via X, Escape, or backdrop click
    - LBOX-03: Prev/next arrow buttons
    - LBOX-04: Arrow key navigation
    - LBOX-05: Caption overlay from alt text
    - LBOX-06: Swipe navigation on mobile
    - LBOX-07: Pinch-to-zoom on mobile
    - LBOX-08: Smooth open/close/slide animations
    - LBOX-09: Images grouped by page
  </what-built>
  <how-to-verify>
    1. Run `npm start` to launch dev server
    2. Open http://localhost:8080/blog/nore-valley-park/ (or any post with images)
    3. Click an image -- it should open in a full-viewport lightbox overlay
    4. Verify caption text appears at bottom of lightbox (alt text from the image)
    5. Press Escape -- lightbox should close
    6. Click image again, then click the dark backdrop area -- should close
    7. Click image again, click the X button -- should close
    8. If the page has multiple images: open lightbox, use arrow buttons to navigate
    9. With lightbox open, press left/right arrow keys to navigate
    10. Open lightbox, verify smooth zoom-in animation on open and zoom-out on close
    11. (Mobile/touch device) Open lightbox, swipe left/right to navigate
    12. (Mobile/touch device) Pinch-to-zoom on an image in the lightbox
    13. Navigate to a different post -- verify that gallery navigation only cycles through THAT page's images
    14. Check that the site logo and navigation images do NOT open in lightbox when clicked
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` succeeds without errors
2. Built HTML contains `lightgallery` class on content image links
3. Built HTML contains `data-gallery` attributes with page-specific slugs
4. Built HTML contains `data-title` attributes with alt text values
5. Non-content images (logo, icons, nav) are NOT lightbox-wrapped
6. Lightbox opens on click, closes on Escape/X/backdrop
7. Arrow navigation works (buttons + keyboard)
8. Captions display at bottom of lightbox
9. Gallery grouping keeps navigation within current page
</verification>

<success_criteria>
- All 9 LBOX requirements are met (LBOX-01 through LBOX-09)
- Every content image site-wide opens in lightbox when clicked
- No regressions to existing site functionality
- User has verified the implementation works on desktop (and ideally mobile)
</success_criteria>

<output>
After completion, create `.planning/phases/01-lightbox-viewer/01-02-SUMMARY.md`
</output>
